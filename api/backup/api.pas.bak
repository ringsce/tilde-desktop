unit api;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils, fphttpclient, fpjson, jsonparser, Process;

type
  TAPIClient = class
  private
    FBaseURL: string;
  public
    constructor Create(const ABaseURL: string);
    function Get(const AEndpoint: string): string;
    function Post(const AEndpoint: string; const AData: TJSONStringType): string;
  end;

procedure InitProject;
procedure SyncRepository;
procedure BuildFromSource;
procedure ResetProject;
function ExecuteShellCommand(const ACommand: string): string;
procedure CloneSource;

implementation

constructor TAPIClient.Create(const ABaseURL: string);
begin
  FBaseURL := ABaseURL;
end;

function TAPIClient.Get(const AEndpoint: string): string;
var
  Client: TFPHTTPClient;
begin
  Client := TFPHTTPClient.Create(nil);
  try
    Result := Client.Get(FBaseURL + AEndpoint);
  finally
    Client.Free;
  end;
end;

function TAPIClient.Post(const AEndpoint: string; const AData: TJSONStringType): string;
var
  Client: TFPHTTPClient;
begin
  Client := TFPHTTPClient.Create(nil);
  try
    Client.AddHeader('Content-Type', 'application/json');
    Result := Client.FormPost(FBaseURL + AEndpoint, AData);
  finally
    Client.Free;
  end;
end;

function ExecuteShellCommand(const ACommand: string): string;
var
  Output: TStringList;
  AProcess: TProcess;
begin
  AProcess := TProcess.Create(nil);
  Output := TStringList.Create;
  try
    AProcess.CommandLine := '/bin/sh -c "' + ACommand + '"';
    AProcess.Options := [poUsePipes, poWaitOnExit];
    AProcess.Execute;
    Output.LoadFromStream(AProcess.Output);
    Result := Output.Text;
  finally
    AProcess.Free;
    Output.Free;
  end;
end;

procedure InitProject;
begin
  Writeln('Initializing project...');
  ExecuteShellCommand('make init');
  Writeln('Project initialization completed.');
end;

(* procedure CloneSource *)
procedure CloneSource;
begin
 Writeln(' Cloning System');
 ExecuteShellCommand('git clone https://www.github.com/ekron-realms.git');
 ExecuteShellCommand('git clone https://www.github.com/kayte-lang.git');
 ExecuteShellCommand('git clone https://www.github.com/kayteide.git');
 ExecuteShellCommand('git clone https://www.github.com/sb_rpg.git');
 ExecuteShellCommand('git clone https://www.github.com/kcc.git');




end;

procedure SyncRepository;
begin
  Writeln('Syncing repository...');
  ExecuteShellCommand('cd tilde-desktop && git pull origin main');
  Writeln('Repository sync completed.');
end;

procedure BuildFromSource;
begin
  Writeln('Building SDK from source...');
  ExecuteShellCommand('cd tilde-desktop && make');
  Writeln('Build completed.');
  SyncRepository;
end;

procedure ResetProject;
begin
  Writeln('Resetting project...');
  ExecuteShellCommand('cd tilde-desktop && git reset --hard && git clean -fd');
  Writeln('Project reset completed.');
  SyncRepository;
end;

end.
